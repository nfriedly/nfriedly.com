<!DOCTYPE html>
<html lang="en">
<head>
<title>Automatically removing spamers from the WordPress Coment Notifier Plugin's Database</title>


    <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/r29/html5.min.js"></script><![endif]-->


<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="DocPad v6.79.4" />
<link rel="canonical" href="https://www.nfriedly.com/techblog/2013/03/automatically-removing-spamers-from-the-wordpress-coment-notifier-plugins-database/" />


<script>
function loadBackupCSS(url) {
	var l = document.createElement('link');
	l.rel = 'stylesheet';
	l.href = url;
	document.head.appendChild(l);
}
</script>
<link href='//fonts.googleapis.com/css?family=Raleway:400,400italic,700' rel='stylesheet' type='text/css'>
<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" onerror="loadBackupCSS('/bower_components/bootstrap/dist/css/bootstrap.min.css')">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" onerror="loadBackupCSS('/bower_components/font-awesome/css/font-awesome.min.css')">

<link  rel="stylesheet" href="/styles/styles.css" />

<link rel="openid2.provider" href="https://openid.stackexchange.com/openid/provider">
<link rel="openid2.local_id" href="https://openid.stackexchange.com/user/4dbfb008-6890-4127-8778-d8bcd0031195">

</head>
<body class="post">

<div class="over-footer">


<nav class="navbar navbar-inverse navbar-static-top">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#nav-menu" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">Nathan Friedly</a>
		</div>
		<div id="nav-menu" class="collapse navbar-collapse">
			<ul class="nav navbar-nav">
				<li ><a href="/"><i class="fa fa-home"></i> Home</a></li>
				<li ><a href="/about/"><i class="fa fa-android"></i> About</a></li>
				<li ><a href="/portfolio/"><i class="fa fa-laptop"></i> Portfolio</a></li>
				<li ><a href="/techblog/"><i class="fa fa-terminal"></i> Tech blog</a></li>
			</ul>
			<!-- div class="navbar-right">
				<ul class="nav navbar-nav">
					<li><a href="http://www.incline.digital/">◢ Incline</a></li>
				</ul>
			</div -->
		</div>
	</div>
</nav>


<header class="jumbotron" style="background-image: url(https://farm8.staticflickr.com/7195/6873017519_843f1642ef_b.jpg);">
	<div class="container">
		<h1><a href="/techblog/2013/03/automatically-removing-spamers-from-the-wordpress-coment-notifier-plugins-database/"> Automatically removing spamers from the WordPress Coment Notifier Plugin's Database</a></h1>
		
	</div>
</header>


<main class="container">
<p><a href="/techblog/2013/03/automatically-removing-spamers-from-the-wordpress-coment-notifier-plugins-database/"><img src="https://farm1.staticflickr.com/216/512562593_33dcb600f2_m.jpg" width="240" height="180" alt="Beach" class="right" title="Spam? Not anymore! Now all I do is relax and enjoy :)" /></a> There&#8217;s an awesome <a href="http://wordpress.org/">WordPress</a> plugin called <a href="http://www.satollo.net/plugins/comment-notifier">Comment Notifier</a> &#8211; what it does is add that check box at the bottom of the comments section. If you leave it checked when you add a comment, then it will automatically email you with anyone ease&#8217;s comments in the future.</p>
<p>However, it has a slight problem with spam. When spammers leave comments, my combination of <a href="http://akismet.com/">Akismet</a> and <a href="http://wordpress.org/extend/plugins/nospamnx/">NoSpamNX</a> do a pretty good job of keeping spam comments of of the site, but not before their (usually fake) email gets added to the Comment Notifier database. </p>
<p>Recently, I realized that my server was trying to send out several hundred failing emails any time someone left a comment. I shot a short feature request (and a small donation) to the Comment Notifier plugin&#8217;s author, but then decided that this was one I could take on myself. Here&#8217;s how I did it:</p>
<!--more-->
<h2 id="step-1-back-up-your-database">Step 1: BACK UP YOUR DATABASE</h2>
<p>I&#8217;m using the <a href="http://hmn.md/backupwordpress/">BackUpWordPress</a> so this happens automatically, but I went and ran an extra backup and downloaded the files to my laptop just to be safe.</p>
<h2 id="step-2-clean-up-the-old-data">Step 2: Clean up the old data</h2>
<p>This SQL query deletes every email in the <code>comment_notifier</code> table that doesn&#8217;t have a corresponding comment. (Most likely because the comment was already deleted as spam.)</p>
<pre class="highlight"><code class="hljs sql"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> <span class="hljs-string">`wp_YOUR_PREFIX_comment_notifier`</span> <span class="hljs-keyword">WHERE</span> email <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (
  <span class="hljs-keyword">SELECT</span> comment_author_email <span class="hljs-keyword">FROM</span> <span class="hljs-string">`wp_YOUR_PREFIX_comments`</span>
);
</code></pre>
<p>Obviously, you&#8217;ll need to change the table name prefix (<code>wp_YOUR_PREFIX_</code>) to whatever your install of WP uses.</p>
<h2 id="step-3-add-an-index-7-on-the-comments-comment_author_email-column">Step 3: Add an <a href="http://dev.mysql.com/doc/refman/5.6/en/glossary.html#glos_index">index</a> on the <code>comments.comment_author_email</code> column</h2>
<p>This is required in order to add the Foreign Key constraint in next step. It makes MySQL keep a sorted list of emails in the comments table and automatically update it any time a comment is added or deleted.</p>
<pre class="highlight"><code class="hljs sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`wp_YOUR_PREFIX_comments`</span> <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">INDEX</span> ( <span class="hljs-string">`comment_author_email`</span> );
</code></pre>
<h2 id="step-4-add-a-foreign-key-8-constraint-that-automatically-deletes-spammers-from-the-comment_notifier-table">Step 4: Add a <a href="http://dev.mysql.com/doc/refman/5.6/en/glossary.html#glos_foreign_key">Foreign Key</a> constraint that automatically deletes spammers from the <code>comment_notifier</code> table</h2>
<p>This instructs MySQL to enforce a link between the <code>comment_notifier</code> table and the <code>comments</code> table so that any email address in the <code>comment_notifier</code> table must also be in the comments table, and if it gets deleted from the <code>comments</code> table, then automatically delete it from the <code>comment_notifier</code> table also.</p>
<pre class="highlight"><code class="hljs sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`wp_YOUR_PREFIX_comment_notifier`</span> 
  <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> <span class="hljs-string">`auto_delete_spammers`</span> 
    FOREIGN <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`email`</span>) 
    <span class="hljs-keyword">REFERENCES</span> <span class="hljs-string">`wp_YOUR_PREFIX_comments`</span> (<span class="hljs-string">`comment_author_email`</span>) 
    <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">CASCADE</span>;
</code></pre>
<h2 id="step-5-relax-and-enjoy-img-src-http-farm1-staticflickr-com-231-507111698_72ef071130_m-jpg-class-right-">Step 5: Relax and enjoy <img src="http://farm1.staticflickr.com/231/507111698_72ef071130_m.jpg" class="right"></h2>
<p>Any time a comment is deleted as spam (or for any other reason), your Comment Notifier will no longer try to send emails to that comment&#8217;s author. Your email server will thank you.</p>
<p class="meta"><small class="photocredit"><b>Photo Credits:</b> 
Header photo by <a href="http://www.flickr.com/photos/34022876@N06/6873017519/">kansasphoto</a>.
Palm tree photo by <a href="http://secure.flickr.com/photos/8438819@N03/512562593/">anda (:</a>
Martini photo by <a href="http://www.flickr.com/photos/seriouslyphotographic/507111698/">Seriously Photographic (Jim)</a>
</small></p>




</main>

</div> <!-- .over-footer -->

<footer>
	<div class="container">
		<div class="row">
			<div class="col-md-5 contact">
				<h3 id="contact">Contact Nathan</h3>

				<ul>
					<li>
						<a class="email" title="email">
							<span class="fa-stack">
								<i class="fa fa-square-o fa-stack-2x"></i>
								<i class="fa fa-envelope fa-stack-1x"></i>
							</span>
							<span class="email-text">nathan @ (this website)</span>
						</a>
					</li>
					<li>
						<a class="fa-stack" href="https://github.com/nfriedly" title="GitHub">
							<i class="fa fa-square-o fa-stack-2x"></i>
							<i class="fa fa-github fa-stack-1x"></i>
						</a>
					</li>
					<li>
						<a class="fa-stack" href="http://stackoverflow.com/users/933879/nathan-friedly" title="Stack Overflow">
							<i class="fa fa-square-o fa-stack-2x"></i>
							<i class="fa fa-stack-overflow fa-stack-1x"></i>
						</a>
					</li>
					<li>
						<a class="fa-stack" href="https://www.linkedin.com/in/nathanfriedly" title="LinkedIn">
							<i class="fa fa-square-o fa-stack-2x"></i>
							<i class="fa fa-linkedin fa-stack-1x"></i>
						</a>
					</li>
					<li>
						<a class="fa-stack" href="https://www.facebook.com/nfriedly" title="Facebook">
							<i class="fa fa-square-o fa-stack-2x"></i>
							<i class="fa fa-facebook fa-stack-1x"></i>
						</a>
					</li>
					<li>
						<a class="fa-stack" href="https://twitter.com/nfriedly" title="Twitter">
							<i class="fa fa-square-o fa-stack-2x"></i>
							<i class="fa fa-twitter fa-stack-1x"></i>
						</a>
					</li>
					<li>
						<a class="fa-stack" href="https://www.last.fm/user/nfriedly" title="Last.fm">
							<i class="fa fa-square-o fa-stack-2x"></i>
							<i class="fa fa-lastfm fa-stack-1x"></i>
						</a>
					</li>
					<li>
						<a class="fa-stack" href="http://steamcommunity.com/id/nfriedly" title="Steam">
							<i class="fa fa-square-o fa-stack-2x"></i>
							<i class="fa fa-steam fa-stack-1x"></i>
						</a>
					</li>
					<li>
						<a class="fa-stack" href="https://news.ycombinator.com/user?id=nfriedly" title="Hacker News">
							<i class="fa fa-square-o fa-stack-2x"></i>
							<i class="fa fa-yc fa-stack-1x"></i>
						</a>
					</li>
					<li>
						<a class="fa-stack" href="https://www.goodreads.com/user/show/63990321-nathan-friedly" title="Goodreads">
							<i class="fa fa-square-o fa-stack-2x"></i>
							<i class="fa fa-book fa-stack-1x"></i>
						</a>
					</li>
					<li>
						<a class="fa-stack" href="https://angel.co/nathan-friedly" title="AngelList">
							<i class="fa fa-square-o fa-stack-2x"></i>
							<i class="fa fa-angellist fa-stack-1x"></i>
						</a>
					</li>
				</ul>
			</div>

			<div class="col-md-3 sitemap">
				<h3>Site Map</h3>
				<ul class="fa-ul">
					<li><a href="/"><i class="fa-li fa fa-home"></i> Home</a></li>
					<li><a href="/about/"><i class="fa-li fa fa-android"></i>About</a></li>
					<li><a href="/portfolio/"><i class="fa-li fa fa-laptop"></i>Portfolio</a></li>
					<li><a href="/techblog/"><i class="fa-li fa fa-terminal"></i>Tech blog</a></li>
				</ul>
			</div>

			<div class="col-md-4 info">
				<p><a href="http://www.nfriedly.com" title="Nathan Friedly: JavaScript &amp; Node.js Expert">Website by Nathan Friedly</a></p>
				<!-- p><a href="http://www.incline.systems">◢ Incline: JavaScript &amp; Node.js Experts</a></p -->
				<p><a rel="license" href="http://creativecommons.org/licenses/by/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="https://licensebuttons.net/l/by/3.0/88x31.png" class="pull-left" /></a> Content licensed under <a rel="license" href="http://creativecommons.org/licenses/by/3.0/deed.en_US">Creative Commons Attribution</a>.</p>
				<p><a href="https://github.com/nfriedly/nfriedly.com"><i class="fa fa-github"></i> Source code available on Github</a> under a <a href="http://opensource.org/licenses/MIT">MIT License</a></p>

				<p>Built with <a href="http://docpad.org">DocPad</a>,
					<a href="http://getbootstrap.com/">Bootstrap</a>,
					and <a href="http://www.nodejs.org/">Node.js</a>.
				</p>
			</div>
		</div>
	</div>
</footer>
<div class="chromefix"></div>

<script>
function loadBackupJS(url) {
	var s = document.createElement('script');
	s.src = url;
	document.head.appendChild(s);
}
</script>


	<!--[if lt IE 9]>
		<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<![endif]-->
	<!--[if gte IE 9]><!-->
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" onerror="loadBackupJS('/bower_components/jquery/dist/jquery.min.js')"></script>
	<!--<![endif]-->
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" defer></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js" onerror="loadBackupJS('/bower_components/lodash/dist/lodash.min.js')"></script>


<script defer="defer"  src="/scripts/email.js"></script>



	<script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-1735765-3']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    
    <script>
window['_fs_debug'] = false;
window['_fs_host'] = 'fullstory.com';
window['_fs_script'] = 'edge.fullstory.com/s/fs.js';
window['_fs_org'] = 'ZMV7P';
window['_fs_namespace'] = 'FS';
(function(m,n,e,t,l,o,g,y){
    if (e in m) {if(m.console && m.console.log) { m.console.log('FullStory namespace conflict. Please set window["_fs_namespace"].');} return;}
    g=m[e]=function(a,b,s){g.q?g.q.push([a,b,s]):g._api(a,b,s);};g.q=[];
    o=n.createElement(t);o.async=1;o.crossOrigin='anonymous';o.src='https://'+_fs_script;
    y=n.getElementsByTagName(t)[0];y.parentNode.insertBefore(o,y);
    g.identify=function(i,v,s){g(l,{uid:i},s);if(v)g(l,v,s)};g.setUserVars=function(v,s){g(l,v,s)};g.event=function(i,v,s){g('event',{n:i,p:v},s)};
    g.anonymize=function(){g.identify(!!0)};
    g.shutdown=function(){g("rec",!1)};g.restart=function(){g("rec",!0)};
    g.log = function(a,b){g("log",[a,b])};
    g.consent=function(a){g("consent",!arguments.length||a)};
    g.identifyAccount=function(i,v){o='account';v=v||{};v.acctId=i;g(o,v)};
    g.clearUserCookie=function(){};
    g.setVars=function(n, p){g('setVars',[n,p]);};
    g._w={};y='XMLHttpRequest';g._w[y]=m[y];y='fetch';g._w[y]=m[y];
    if(m[y])m[y]=function(){return g._w[y].apply(this,arguments)};
    g._v="1.3.0";
})(window,document,window['_fs_namespace'],'script','user');
</script>



</body>
</html>
